---
tags: python
---
# python

## 装饰器

### dataclass

it will make the class comparable, (imuttable, hashable)

```python
from dataclasses import dataclass, field
@dataclass(frozen=True)
class Comment:
    id: int = field()
    text: str = field(default="")
```

### `@property`

Python 内置的 `@property` 装饰器就是负责把一个方法变成属性调用的。把一个 `getter` 方法变成属性，只需要加上 `@property` 就可以了

`@property` 本身又创建了另一个装饰器 `@(under property function).setter`，负责把一个 `setter` 方法变成属性赋值

其实利用了描述符(descriptor)，即将该类方法变成含有 `__get__` `__set__` `__delete__` 方法

## [[meta programming]]

## GC

函数内循环引用，函数结束后无法释放内存。

- 小整数[-5, 256]对象在解释器初始化时确定，相同的小整数是同一个 id
- 大整数每次都会生成新的 id
- 字符串驻留(intern)，相同的字符串指向相同的位置(字符串中不包含特殊字符)

### 手动清除

```python
import gc
def recur():
    a = [i for i in range(100_0000_0000)]
    b = [i for i in range(100_0000_0000)]
    a.append(b)
    b.append(a)

recur()

gc.collect()
```

### 机制

引用计数为主，分代收集为辅。当引用数为 0 时清除

## 上下文管理器

避免 IO 过程中出现错误没有释放资源

### 类的方法实现

只要实现了 `__enter__` 和 `__exit__` 方法，就可以用 `with` 来管理

### 方法实现

`@contextmanager` 这个 decorator 接受一个 generator，用 yield 语句把 with &#x2026; as var 把变量输出出去，然后，with 语句就可以正常地工作了：

```python
from contextlib import contextmanager

@contextmanager
def my_open(path, mode):
    f = open(path, mode)
    """__enter__"""
    yield f
    """__exit__"""
    f.close()
with my_open("file","w") as f:
    f.write(123)
```

## build system

poetry can do the best as far as I can see

```shell
poetry new project
poetry init
poetry add package
poetry install
poetry build    # 构建可安装的 *.whl 和 tar.gz 文件
poetry shell    # 会根据定义在 pyproject.toml 文件中的依赖创建并使用虚拟环境
poetry run pytest    # 运行使用 pytest 的测试用例，如 tests/test_sample.py
poetry run python -m unittest tests/sample_tests.py  # 运行 unittest 测试用例
poetry export --without-hashes --output requirements.txt  # 导出 requirements.txt 文件, --dev  导出含 dev 的依赖，或者用 poetry export --without-hashes > requirements.txt
poetry run my-script
```

poetry generates pyproject.toml

```toml
[tool.poetry.scripts]
my-script="modulename.filename:function_name"
```

[//begin]: # "Autogenerated link references for markdown compatibility"
[meta programming]: <meta programming.md> "元编程"
[//end]: # "Autogenerated link references"
