---
tags: CSAPP
---

# 虚拟内存

对[[RAM]]的抽象概念，完成内存管理操作。可以看作磁盘上 N 个连续字节组成的数组。好处是

- 把 DRAM 看作是虚拟内存的 cache，使内存访问更高效
- 所有的进程看到相同的虚拟内存方便管理
- 使不同地址空间独立

## 虚拟内存作用

### VM as Cache

缓存算法比 [[在线算法#LRU]] 算法更复杂，进程的 page table entries (PTE)保存在 page table 中，由内核维护，MMU 寻址。
寻址操作分为

- 物理寻址：把内存看成数组，按物理地址(起始地址+长度)通过[[计算机组成#总线]]传递到内存
- 虚拟寻址：虚拟地址转换为物理地址的任务称为“地址翻译”，由[[计算机组成#处理器]]的 MMU 负责。虚拟内存由虚拟页 VP 组成(4kb-2Gb，与真实的物理内存帧相同)，分为
  - 未分配的：不占用磁盘空间，需要分配(如 `malloc`)时调用 `sbrk` 来分配地址并放到 page table 中
  - 已缓存的：已经缓存在物理内存页中
  - 未缓存的：在磁盘中但不在内存中。如果没有命中触发一个 fault，handler 选择一个 victim 从内存中删除并把 virtual page 存到内存中

### VM as memory management

VM 给进程提供了一个看似连续的内存空间，但是实际的物理内存可能是分散的。
此外，共享库只需要加载一次到物理内存，然后由不同的虚拟内存对这块 page 引用，避免了共享库重复加载。
统一的内存模型还方便了[[链接]]器和[[进程#：替换状态机|execve]]

### VM as memory protection

给 PTE 高位加 1，作为内核的代码和数据区域，进而对进程可访问的区域做出限制

## `mmap` 内存映射

虚拟内存映射到文件系统中的普通文件，也可以映射到内核创建的匿名文件

## [[动态内存分配]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[RAM]: ../../ee/lib/RAM.md "内存"
[在线算法#LRU]: ../../algorithm/algorithms/%E5%9C%A8%E7%BA%BF%E7%AE%97%E6%B3%95.md "在线算法"
[计算机组成#总线]: ../计算机组成/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90.md "计算机组成"
[计算机组成#处理器]: ../计算机组成/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BB%84%E6%88%90.md "计算机组成"
[链接]: ../程序的结构/%E9%93%BE%E6%8E%A5.md "链接"
[进程#：替换状态机|execve]: <../../operating system/虚拟化/%E8%BF%9B%E7%A8%8B.md> "进程"
[动态内存分配]: %E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.md "动态内存分配"
[//end]: # "Autogenerated link references"
