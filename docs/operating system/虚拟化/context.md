---
tags: OS
---

# 上下文切换

先把前一个任务的 CPU 上下文（也就是 CPU 寄存器和程序计数器）保存起来，然后加载新任务的上下文到这些寄存器和程序计数器，最后再跳转到程序计数器所指的新位置，运行新任务。

## 虚拟化

通过虚拟化，操作系统给用户提供了一个独占 CPU 的假象。过程是：

- 硬件发生中断
- 切换到操作系统代码执行
  - 切换时，对寄存器做 snapshot & switch
- 操作系统代码可以切换到另一个进程执行

## 处理器调度

处理器可以以固定的频率被中断，中断/系统调用返回时可以自由选择[[进程]]/[[线程]]执行。
调度策略可以是：

- Round-Robin：中断后试图切换到下一个线程，如果正在等待 IO 则尝试下一个
  - 可以给进程设置优先级(`nice` 越大优先级越低)，常用于实时性要求较高的系统
- MLFQ：动态调整优先级，用完时间片降低 nice，主动让出则增加 nice
- CFS：每次中断/异常发生后，切换到运行时间最少的进程执行

可能导致优先级翻转的 bug：高优先级由于锁被低优先级持有，反而等待中等优先级的程序。

[//begin]: # "Autogenerated link references for markdown compatibility"
[进程]: 进程.md "进程"
[线程]: ../并发/线程.md "线程"
[//end]: # "Autogenerated link references"
