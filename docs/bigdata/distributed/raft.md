---
tags: algorithm, devops
---

# Raft 算法

Raft 把共识算法分解为三个子问题：Leader 选举、日志复制和安全性。Raft 通过 Leader 选举来保证安全性，通过日志复制来保证可用性。

## 背景

> 有点像分布式的[[database systems/logging]]系统，是[[paxos]]易于理解的实现

Raft 节点分为三种角色：

- Leader：负责处理客户端的请求，将请求转换为日志条目并复制到其他节点。发出 AppendEntries RPC 请求
- Candidate：发起选举，请求成为 Leader。发出 RequestVote RPC 请求
- Followers

Raft 把时间分割成任期(term)，每个任期都有一个 Leader。任期内，Leader 负责处理客户端的请求，将请求转换为日志条目并复制到其他节点。任期结束于 Leader 崩溃/超时/无法选出 ，此时会发起选举，选出新的 Leader。

RPC 请求会携带当前任期号，如果请求的任期号小于当前任期号，则拒绝请求。Candidate/Leader 发现自己过期就会转换为 Follower。

## Leader 选举

Raft Leader 会周期性地发送心跳包，如果某个节点在一段时间内没有收到 Leader 的心跳包，则会发起选举。

开启一个选举后，Follower 会先递增自己的任期号，然后转换为 Candidate 并投票给自己，然后向其他所有节点发起 RPC 投票请求。结果有三种

- 如果 Candidate 收到大多数节点的投票，则成为 Leader 并发送心跳
- 如果其他节点赢得了选举，收到新 Leader 的心跳包后，Candidate 发现新 Leader 任期号不小于自己当前任期号，会转换为 Follower
- 如果一段时间后没有然后一个 Candidate 获得超过半数选票，则 Candidate 在超过自己随机选举时间后开始新一轮投票

## 日志复制

日志包含三条信息：任期号、指令、日志索引。任期号和日志索引可以唯一确定一条日志。

Leader 并行地向其他节点发送 AppendEntries RPC 请求，收到大多数节点的响应后，Leader 将日志条目应用到状态机中(称之为**提交**)。

Raft 在有宕机的情况下日志复制有三种可能：

- Follower 没有响应：Leader 会重试
- Follower 崩溃后恢复：根据一致性检查，向 Leader 请求日志定位到缺失日志，然后重新发送日志
- Leader 在未提交时崩溃：Follower 中跟 Leader 冲突的日志会被新 Leader 覆盖

## 安全性

- Candidate 日志确保完整：RequestVote RPC 请求中包含 Candidate 最后一条日志的任期号和索引，如果最后一条日志比其他节点旧，则不会投票给 Candidate
- 新 Leader 是否要提交之前任期的日志条目：Leader 的 AppendEntries RPC 请求中包含 Leader 已经提交的日志号(心跳 RPC 也包含这一参数)，Follower 确认 Leader 提交后才真正提交

[//begin]: # "Autogenerated link references for markdown compatibility"
[database systems/logging]: <../../database/database systems/logging.md> "logging"
[//end]: # "Autogenerated link references"
