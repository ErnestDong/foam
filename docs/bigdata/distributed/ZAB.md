---
tags: algorithm, devops
---

# ZAB

也是[[paxos]]的一种变体

## 角色

ZAB 协议中，节点的角色有两种。

- Leader 节点
  - Leader 是一个临时角色，它是有任期的。
  - Leader 节点控制着算法执行的过程，广播消息并保证消息是按顺序传播的。
  - 读写操作都要经过它，从而保证操作的都是最新的数据。
  - 如果一个客户端连接的不是 Leader 节点，它发送的消息也会转发到 Leader 节点中。
- Follower 节点。
  - 主要作用是接受 Leader 发送的消息，并检测 Leader 的健康状态。

## 过程

- **Leader election**：与[[raft]]类似的领导选举算法，在选举的时候 `lastProcessedZxid` 越大，越有可能成为 leader
- **Discovery**：
  - leader 收集 follower 的 `lastProcessedZxid`，用来通过和 leader 的 `lastProcessedZxid` 对比来确认 follower 需要同步的数据范围。
  - 选举出一个新的 peerEpoch，主要用于防止旧的 leader 来进行提交操作（旧 leader 向 follower 发送命令的时候，follower 发现事务 id 所在的 peerEpoch 比现在的小，则直接拒绝，防止出现不一致性）
- **Synchronization**：follower 中的事务日志和 leader 保持一致的过程，就是依据 follower 和 leader 之间的 `lastProcessedZxid` 进行，follower 多的话则删除掉多余部分，follower 少的话则补充，一旦对应不上则 follower 删除掉对不上的事务 id 及其之后的部分然后再从 leader 同步该部分之后的数据
- **Broadcast** 正常处理客户端请求的过程。leader 针对客户端的事务请求，然后提出一个议案，发给所有的 follower，一旦过半的 follower 回复 OK 的话，leader 就可以将该议案进行提交了，向所有 follower 发送提交该议案的请求，leader 同时返回 OK 响应给客户端

[//begin]: # "Autogenerated link references for markdown compatibility"
[paxos]: paxos.md "Paxos 算法"
[raft]: raft.md "Raft 算法"
[//end]: # "Autogenerated link references"
