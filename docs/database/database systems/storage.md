---
tags: Database
---
# 存储设备

## [[OS]]视角下的[[计算机组成#文件系统]]

## [[数据库]]视角下的存储设备

内存作为磁盘的缓存。DBMS 不使用 [[os]]提供的 `mmap` 因为 DBMS 知道数据是如何处理的，而是使用以下的 syscall：

- `madvise`: 告诉系统要读某页
- `mlock`: 告诉系统不要清理内存写入磁盘
- `msync`: 告诉系统把内存写入到磁盘

空间控制的目标是使经常在一起使用的页面在物理上尽可能靠近磁盘。
时间控制旨在最大限度地减少不得不从磁盘读取数据的停顿次数。

### file storage

DBMS 通常把数据库写入到文件/文件层级结构中，管理这些文件依靠 DBMS 的 storage manager，storage manager 把文件表示成 page

### page storage

DBMS 把一个或多个文件划分为固定大小的 page，通常 1-16KB，存储 tuple/index。每个 page 有单独的 id，

#### database [[堆]]

堆文件组织找到 DBMS 想要的 page 在磁盘上的位置的方法之一。
堆文件是以随机顺序存储 tuple 的 page 的无序集合。在给定页面ID的情况下，DBMS可以通过使用页面的链接列表或页面目录来定位磁盘上的页面。

- 链接列表：标题页包含指向自由页面列表和数据页面列表的指针。但是，如果DBMS正在查找特定的页，则它必须对数据页列表进行顺序扫描，直到找到它正在查找的页。
- 页面目录：DBMS维护特殊页面，跟踪数据页面的位置以及每个页面上的空闲空间量

#### page layout

每个 page 包括一个 header，记录了一些关于本页的元信息。

page 的内容并非直接在空处插入数据，因为会带来删除的麻烦。因而布局数据时会采用

- slotted pages：大多数 DBMS 使用
  - header 存储用到的 slots 数、最后一个用到的 slot 的位置与所有 tuple 的位置
  - 要添加一个 tuple，slot数组将从头到尾增长，而 tuple 的数据将从头到尾增长。当 slot 数组和 tuple 数据相遇时，认为该页已满。
- log-structured：只存储 log 记录

#### tuple layout

tuple 是二进制序列，由 DBMS encode/decode。也分为 header 和数据。大多 DBMS 不能储存超出 page 大小的数据。tuple 有唯一的 id，但不表示任何意义

### tuple 如何存储在 page 上

- OLTP：Online Transaction Processing，主要处理写
- OLAP：Online Analytical Processing，主要处理读
- HTAP：以上两种混合

#### N-Ary Storage Model

把 tuple 所有属性存储连续存储在 page 上，方便 OLTP 增删改，但不方便查询大的数据，因为会污染 [[buffer_pools]]

#### Decomposition Storage Model

存储 tuple 中的一个属性，即“列存储”，适合 OLAP 和压缩，但不容易增删改

### [[数据库]]视角下的[[信息]]表示

- 整数：INTEGER BIGINT SMALLINT TINYINT
- 可变精度数：FLOAT REAL
- Fixed-Point Precision Numbers：NUMERIC DECIMAL 。几乎等同于字符串，在 rounding error 不可忽略的时候使用，但影响性能
- Variable-Length Data：VARCHAR VARBINARY TEXT BLOB。它们通常与字符串长度一起存储，以便于跳转到下一个值。它还可以包含数据的校验和。如果比较大，会储存在外部，内部保留一个指针，但因此无法做到 durability 或事务
- Dates/Times：TIME，DATE，TIMESTAMP
- System Catalogs：为了使 DBMS 能够解码 tuple 的内容，它维护一个有关数据库的元数据的内部目录。元数据将包含有关数据库具有哪些表和列的信息，以及它们的类型和值的排序。大多数DBMS以用于其表的格式将其目录存储在其内部。他们使用特殊代码来“引导”这些目录表。

## [[buffer_pools]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[OS]: <../../operating system/os.md> "操作系统"
[计算机组成#文件系统]: ../../csapp/计算机组成/计算机组成.md "计算机组成"
[数据库]: ../数据库.md "数据库"
[虚拟内存]: ../../csapp/程序的执行/虚拟内存.md "虚拟内存"
[os]: <../../operating system/os.md> "操作系统"
[堆]: ../../algorithm/data_structure/堆.md "堆"
[buffer_pools]: buffer_pools.md "buffer pools"
[信息]: ../../csapp/程序的结构/信息.md "信息的表示与处理"
[//end]: # "Autogenerated link references"
