---
tags: CS, CSAPP
---
# 虚拟内存

对内存的抽象概念，完成内存管理操作。可以看作磁盘上 N 个连续字节组成的数组。好处是

- 把 DRAM 看作是虚拟内存的 cache，使内存访问更高效
- 所有的进程看到相同的虚拟内存方便管理
- 使不同地址空间独立

## 虚拟内存作用

### VM as Cache

缓存算法比 LRU 算法更复杂，进程的 page table entries (PTE)保存在 page table 中，由内核维护，MMU 寻址。
寻址操作分为

- 物理寻址：把内存看成数组，按物理地址(起始地址+长度)通过[[计算机组成#总线]]传递到内存
- 虚拟寻址：虚拟地址转换为物理地址的任务称为“地址翻译”，由[[计算机组成#处理器]]的 MMU 负责。虚拟内存由虚拟页 VP 组成(4kb-2Gb，与真实的物理内存帧相同)，分为
  - 未分配的：不占用磁盘空间，需要分配(如 `malloc`)时调用 `sbrk` 来分配地址并放到 page table 中
  - 已缓存的：已经缓存在物理内存页中
  - 未缓存的：在磁盘中但不在内存中。如果没有命中除法触发一个 fault [[并发#异常]]，handler 选择一个 victim 从内存中删除并把 virtual page 存到内存中

### VM as memory management

VM 给进程提供了一个看似连续的内存空间，但是实际的物理内存可能是分散的。
此外，共享库只需要加载一次到物理内存，然后由不同的虚拟内存对这块 page 引用，避免了共享库重复加载。
统一的内存模型还方便了[[链接]]器和[[进程#：替换状态机|execve]]

### VM as memory protection

给 PTE 高位加 1，作为内核的代码和数据区域，进而对进程可访问的区域做出限制

## `mmap` 内存映射

虚拟内存映射到文件系统中的普通文件，也可以映射到内核创建的匿名文件

## [[动态内存分配]]

[//begin]: # "Autogenerated link references for markdown compatibility"
[计算机组成#总线]: 计算机组成.md "计算机组成"
[计算机组成#处理器]: 计算机组成.md "计算机组成"
[并发#异常]: 并发.md "并发"
[链接]: 链接.md "链接"
[进程#：替换状态机|execve]: <../operating system/进程.md> "进程"
[动态内存分配]: 动态内存分配.md "动态内存分配"
[//end]: # "Autogenerated link references"
